
{% extends 'users/base.html' %}

{% block users_title %}Analytics Dashboard - CoralOffice{% endblock %}

{% block users_content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="p-3">
    <div style="margin-bottom: 20px;">
        <h2>Analytics Dashboard</h2>
    </div>

    <div style="margin-bottom: 20px;">
        <a href="{% url 'users:diving_center_dashboard' %}" class="btn" style="background: #6c757d;">Back to Dashboard</a>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Customers</h5>
                    <h2 style="color: #4CAF50;">{{ total_customers }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Activities</h5>
                    <h2 style="color: #2196F3;">{{ total_activities }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Avg Activities/Customer</h5>
                    <h2 style="color: #9c27b0;">{{ avg_activities|floatformat:1 }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Countries</h5>
                    <h2 style="color: #ff9800;">{{ countries|length }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ current_year }} YTD Dives</h5>
                    <h2 style="color: #e91e63;">{{ year_to_date_total }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">{{ current_year }} Total Dives</h5>
                    <h2 style="color: #795548;">{{ total_activities_year }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="row">
        <!-- Country Distribution -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>Customer Distribution by Country</h5>
                </div>
                <div class="card-body">
                    <canvas id="countryChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Age Range Distribution -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>Age Range Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="ageChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>

        <!-- Activities Over Time -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>Activities Over Time</h5>
                </div>
                <div class="card-body">
                    <canvas id="timelineChart" width="400" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Monthly Activities Chart -->
        <div class="col-md-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5>Scheduled Dives by Month ({{ current_year }})</h5>
                </div>
                <div class="card-body">
                    <canvas id="monthlyChart" width="400" height="100"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Country Chart
const countryCtx = document.getElementById('countryChart').getContext('2d');
const countryChart = new Chart(countryCtx, {
    type: 'pie',
    data: {
        labels: {{ countries.keys|safe }},
        datasets: [{
            data: {{ countries.values|safe }},
            backgroundColor: [
                '#FF6384',
                '#36A2EB',
                '#FFCE56',
                '#4BC0C0',
                '#9966FF',
                '#FF9F40',
                '#FF6384',
                '#C9CBCF'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false
    }
});

// Age Chart
const ageCtx = document.getElementById('ageChart').getContext('2d');
const ageChart = new Chart(ageCtx, {
    type: 'bar',
    data: {
        labels: {{ age_ranges.keys|safe }},
        datasets: [{
            label: 'Customers',
            data: {{ age_ranges.values|safe }},
            backgroundColor: [
                '#4CAF50',
                '#2196F3',
                '#FF9800',
                '#9C27B0',
                '#F44336',
                '#607D8B'
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});

// Activities Over Time Chart
const timelineCtx = document.getElementById('timelineChart').getContext('2d');
const timelineChart = new Chart(timelineCtx, {
    type: 'line',
    data: {
        labels: {{ date_labels|safe }},
        datasets: [{
            label: 'Activities',
            data: {{ date_counts|safe }},
            borderColor: '#2196F3',
            backgroundColor: 'rgba(33, 150, 243, 0.1)',
            tension: 0.1,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: true
            },
            tooltip: {
                mode: 'index',
                intersect: false
            }
        }
    }
});

// Monthly Activities Chart
const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
const monthlyChart = new Chart(monthlyCtx, {
    type: 'bar',
    data: {
        labels: [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ],
        datasets: [{
            label: 'Scheduled Dives',
            data: [
                {% for month, count in monthly_activities.items %}
                    {{ count }}{% if not forloop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                '#e3f2fd', '#bbdefb', '#90caf9', '#64b5f6',
                '#42a5f5', '#2196f3', '#1e88e5', '#1976d2',
                '#1565c0', '#0d47a1', '#82b1ff', '#448aff'
            ],
            borderColor: '#1976d2',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        },
        plugins: {
            legend: {
                display: true
            },
            tooltip: {
                callbacks: {
                    title: function(context) {
                        return context[0].label + ' {{ current_year }}';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
