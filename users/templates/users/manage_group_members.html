{% extends 'users/base.html' %}

{% block users_title %}Manage Group Members - {{ group.name }}{% endblock %}

{% block users_content %}
<h2>Manage Members - {{ group.name }}</h2>

<div style="margin-bottom: 20px;">
    <a href="{% url 'users:diving_groups_list' %}" class="btn" style="background: #6c757d;">Back to Groups</a>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
    <!-- Current Members -->
    <div>
        <h3>Current Members ({{ members.count }})</h3>
        {% if members %}
            {% for member in members %}
            <div class="participant-card" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4>{{ member.customer.first_name }} {{ member.customer.last_name }}</h4>
                    <p>{{ member.customer.email }}</p>
                    <p><strong>Certification:</strong> {{ member.customer.get_certification_level_display }}</p>
                    {% if member.is_leader %}
                        <span style="background-color: #ff9800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px;">Group Leader</span>
                    {% endif %}
                </div>
                <form method="post" style="margin: 0;">
                    {% csrf_token %}
                    <input type="hidden" name="member_id" value="{{ member.id }}">
                    <button type="submit" name="remove_member" class="btn" style="background: #f44336; padding: 5px 10px; font-size: 12px;">Remove</button>
                </form>
            </div>
            {% endfor %}
        {% else %}
            <p>No members in this group yet.</p>
        {% endif %}
    </div>

    <!-- Add Members -->
    <div>
        <h3>Add Members</h3>
        {% if available_customers %}
        <form method="post" style="margin-bottom: 20px;">
            {% csrf_token %}
            <div style="display: flex; gap: 10px; align-items: end;">
                <div style="flex: 1; position: relative;">
                    <label>Search Customer:</label>
                    <input type="text" id="member-search" placeholder="Start typing customer name..." autocomplete="off" class="form-control">
                    <div id="member-suggestions" class="search-suggestions" style="border: 1px solid #ddd; max-height: 200px; overflow-y: auto; position: absolute; background: white; width: 100%; z-index: 100; display: none;"></div>
                    <select name="customer_id" id="customer-select" class="form-control" style="display: none;">
                        <option value="">Select a customer</option>
                        {% for customer in available_customers %}
                            <option value="{{ customer.id }}">{{ customer.first_name }} {{ customer.last_name }} ({{ customer.get_country_display }})</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="submit" name="add_member" class="btn">Add Member</button>
            </div>
        </form>

        <script>
        // Customer search functionality for group members
        const memberSearch = document.getElementById('member-search');
        const customerSelectDropdown = document.getElementById('customer-select');
        const memberSuggestionsDiv = document.getElementById('member-suggestions');

        const availableCustomers = [
            {% for customer in available_customers %}
            {
                id: {{ customer.id }},
                name: "{{ customer.first_name }} {{ customer.last_name }}",
                country: "{{ customer.get_country_display }}",
                certification: "{{ customer.get_certification_level_display }}"
            },
            {% endfor %}
        ];

        memberSearch.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            if (query.length < 2) {
                memberSuggestionsDiv.style.display = 'none';
                return;
            }

            const matches = availableCustomers.filter(customer => 
                customer.name.toLowerCase().includes(query)
            );

            if (matches.length > 0) {
                memberSuggestionsDiv.innerHTML = matches.map(customer => 
                    `<div class="suggestion-item" data-value="${customer.id}" style="padding: 10px; cursor: pointer; border-bottom: 1px solid #eee;">
                        <strong>${customer.name}</strong><br>
                        <small>${customer.country} â€¢ ${customer.certification}</small>
                    </div>`
                ).join('');
                memberSuggestionsDiv.style.display = 'block';
            } else {
                memberSuggestionsDiv.style.display = 'none';
            }
        });

        memberSuggestionsDiv.addEventListener('click', function(e) {
            const suggestionItem = e.target.closest('.suggestion-item');
            if (suggestionItem) {
                const customerId = suggestionItem.getAttribute('data-value');
                const customer = availableCustomers.find(c => c.id == customerId);

                customerSelectDropdown.value = customerId;
                memberSearch.value = customer.name;
                memberSuggestionsDiv.style.display = 'none';
            }
        });

        document.addEventListener('click', function(e) {
            if (!e.target.closest('form')) {
                memberSuggestionsDiv.style.display = 'none';
            }
        });
        </script>
    {% else %}
        <p>All customers are already members of this group.</p>
    {% endif %}
    </div>
</div>
{% endblock %}