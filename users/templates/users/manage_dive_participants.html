
{% extends 'users/base.html' %}

{% block users_title %}Manage Participants for {{ dive.dive_site }}{% endblock %}

{% block users_content %}
<style>
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background-color: #fefefe;
    margin: 2% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    border-radius: 5px;
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
}

.participant-card {
    border: 1px solid #ddd;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 10px;
    background-color: #f9f9f9;
}

.equipment-list {
    margin-top: 10px;
    font-size: 14px;
}

.equipment-item {
    display: inline-block;
    background-color: #4CAF50;
    color: white;
    padding: 2px 6px;
    margin: 2px;
    border-radius: 3px;
    font-size: 12px;
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: bold;
}

.status-pending { background-color: #ffc107; color: #000; }
.status-departed { background-color: #17a2b8; color: #fff; }
.status-finished { background-color: #28a745; color: #fff; }

.customer-suggestions {
    border: 1px solid #ddd;
    max-height: 200px;
    overflow-y: auto;
    position: absolute;
    background: white;
    width: 100%;
    z-index: 100;
    display: none;
}

.suggestion-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.suggestion-item:hover {
    background-color: #f5f5f5;
}

.quick-edit-form {
    display: none;
    margin-top: 10px;
    padding: 10px;
    background-color: #f0f0f0;
    border-radius: 5px;
}
</style>

<h2>Manage Participants for {{ dive.dive_site }}</h2>
<p><strong>Date:</strong> {{ dive.date }} | <strong>Time:</strong> {{ dive.time }}</p>
<p><strong>Current Participants:</strong> {{ participants.count }}/{{ dive.max_participants }}</p>
{% if dive.special_notes %}
    <div style="background-color: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
        <strong>‚ö†Ô∏è Special Notes:</strong> {{ dive.special_notes }}
    </div>
{% endif %}

<h3>Current Participants</h3>
{% if participants %}
    {% for participant in participants %}
        <div class="participant-card">
            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <h4>{{ participant.customer.first_name }} {{ participant.customer.last_name }}</h4>
                    <p><strong>Certification Level:</strong> {{ participant.customer.get_certification_level_display }}</p>
                    <p><strong>Country:</strong> {{ participant.customer.country|default:"Not specified" }} | <strong>Language:</strong> {{ participant.customer.get_language_display }}</p>
                    <p><strong>Tank Size:</strong> {{ participant.get_tank_size_display }}</p>
                    <p><strong>Activity:</strong> {{ participant.activity.name }}</p>
                    <div style="margin-bottom: 10px;">
                        <span class="status-badge status-{{ participant.status|lower }}">{{ participant.get_status_display }}</span>
                        {% if participant.has_arrived %}<span style="background-color: #28a745; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-left: 5px;">‚úì Arrived</span>{% endif %}
                        {% if participant.is_paid %}<span style="background-color: #007bff; color: white; padding: 2px 6px; border-radius: 3px; font-size: 12px; margin-left: 5px;">üí∞ Paid</span>{% endif %}
                    </div>
                    <div class="equipment-list">
                        <strong>Equipment Needed:</strong>
                        {% if participant.needs_wetsuit %}<span class="equipment-item">Wetsuit</span>{% endif %}
                        {% if participant.needs_bcd %}<span class="equipment-item">BCD</span>{% endif %}
                        {% if participant.needs_regulator %}<span class="equipment-item">Regulator</span>{% endif %}
                        {% if participant.needs_guide %}<span class="equipment-item">Guide</span>{% endif %}
                        {% if participant.needs_insurance %}<span class="equipment-item">Insurance</span>{% endif %}
                        {% if not participant.needs_wetsuit and not participant.needs_bcd and not participant.needs_regulator and not participant.needs_guide and not participant.needs_insurance %}
                            <span style="color: #666;">None</span>
                        {% endif %}
                    </div>
                    
                    <!-- Quick edit form -->
                    <div class="quick-edit-form" id="edit-form-{{ participant.id }}">
                        <form method="post" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                            {% csrf_token %}
                            <input type="hidden" name="participant_id" value="{{ participant.id }}">
                            <div>
                                <label>Tank Size:</label>
                                <select name="tank_size" class="form-control">
                                    {% for value, label in tank_size_choices %}
                                        <option value="{{ value }}" {% if participant.tank_size == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div>
                                <label>Status:</label>
                                <select name="status" class="form-control">
                                    {% for value, label in status_choices %}
                                        <option value="{{ value }}" {% if participant.status == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label><input type="checkbox" name="needs_wetsuit" {% if participant.needs_wetsuit %}checked{% endif %}> Wetsuit</label>
                                <label><input type="checkbox" name="needs_bcd" {% if participant.needs_bcd %}checked{% endif %}> BCD</label>
                                <label><input type="checkbox" name="needs_regulator" {% if participant.needs_regulator %}checked{% endif %}> Regulator</label>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label><input type="checkbox" name="needs_guide" {% if participant.needs_guide %}checked{% endif %}> Guide</label>
                                <label><input type="checkbox" name="needs_insurance" {% if participant.needs_insurance %}checked{% endif %}> Insurance</label>
                                <label><input type="checkbox" name="has_arrived" {% if participant.has_arrived %}checked{% endif %}> Has Arrived</label>
                                <label><input type="checkbox" name="is_paid" {% if participant.is_paid %}checked{% endif %}> Is Paid</label>
                            </div>
                            <div style="grid-column: span 2;">
                                <button type="submit" name="quick_update_participant" class="btn" style="background-color: #28a745;">Update</button>
                                <button type="button" onclick="hideQuickEdit({{ participant.id }})" class="btn" style="background-color: #6c757d;">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 5px; margin-left: 15px;">
                    <button onclick="showQuickEdit({{ participant.id }})" class="btn" style="background-color: #ffc107; padding: 5px 10px; font-size: 12px;">Quick Edit</button>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="customer" value="{{ participant.id }}">
                        <button type="submit" name="remove_participant" class="btn" style="background-color: #f44336; padding: 5px 10px; font-size: 12px;">Remove</button>
                    </form>
                </div>
            </div>
        </div>
    {% endfor %}
{% else %}
    <p>No participants registered for this dive yet.</p>
{% endif %}

<h3>Add Participant</h3>
<div style="margin-bottom: 20px;">
    <button onclick="openModal()" class="btn" style="background-color: #2196F3;">Add New Customer</button>
</div>

<form method="post">
    {% csrf_token %}
    <div class="form-row">
        <div class="form-group" style="position: relative;">
            <label for="customer-search">Search Customer:</label>
            <input type="text" id="customer-search" placeholder="Start typing customer name..." autocomplete="off" class="form-control">
            <div id="customer-suggestions" class="customer-suggestions"></div>
            {{ form.customer }}
        </div>
        <div class="form-group">
            <label for="{{ form.activity.id_for_label }}">Activity:</label>
            {{ form.activity }}
        </div>
        <div class="form-group">
            <label for="{{ form.tank_size.id_for_label }}">Tank Size:</label>
            {{ form.tank_size }}
        </div>
    </div>
    
    <div class="checkbox-group">
        <label><input type="checkbox" name="needs_wetsuit" {% if form.needs_wetsuit.value %}checked{% endif %}> Wetsuit</label>
        <label><input type="checkbox" name="needs_bcd" {% if form.needs_bcd.value %}checked{% endif %}> BCD</label>
        <label><input type="checkbox" name="needs_regulator" {% if form.needs_regulator.value %}checked{% endif %}> Regulator</label>
        <label><input type="checkbox" name="needs_guide" {% if form.needs_guide.value %}checked{% endif %}> Guide</label>
        <label><input type="checkbox" name="needs_insurance" {% if form.needs_insurance.value %}checked{% endif %}> Insurance</label>
    </div>
    
    <div style="margin-top: 20px;">
        <button type="submit" name="add_participant" class="btn">Add Participant</button>
        <a href="{% url 'users:dive_detail' dive.id %}" class="btn" style="background: #6c757d;">Back to Dive Details</a>
    </div>
</form>

<!-- Modal for adding new customer -->
<div id="customerModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>Add New Customer</h3>
        <form method="post">
            {% csrf_token %}
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ customer_form.first_name.id_for_label }}">First Name:</label>
                    {{ customer_form.first_name }}
                </div>
                <div class="form-group">
                    <label for="{{ customer_form.last_name.id_for_label }}">Last Name:</label>
                    {{ customer_form.last_name }}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ customer_form.email.id_for_label }}">Email:</label>
                    {{ customer_form.email }}
                </div>
                <div class="form-group">
                    <label for="{{ customer_form.phone_number.id_for_label }}">Phone Number:</label>
                    {{ customer_form.phone_number }}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ customer_form.country.id_for_label }}">Country:</label>
                    {{ customer_form.country }}
                </div>
                <div class="form-group">
                    <label for="{{ customer_form.language.id_for_label }}">Language:</label>
                    {{ customer_form.language }}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ customer_form.birthday.id_for_label }}">Birthday:</label>
                    {{ customer_form.birthday }}
                </div>
                <div class="form-group">
                    <label for="{{ customer_form.certification_level.id_for_label }}">Certification Level:</label>
                    {{ customer_form.certification_level }}
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ customer_form.emergency_contact.id_for_label }}">Emergency Contact:</label>
                    {{ customer_form.emergency_contact }}
                </div>
            </div>
            
            <div class="form-group">
                <label for="{{ customer_form.medical_conditions.id_for_label }}">Medical Conditions:</label>
                {{ customer_form.medical_conditions }}
            </div>
            
            <div style="margin-top: 20px;">
                <button type="submit" name="add_new_customer" class="btn">Add Customer</button>
                <button type="button" onclick="closeModal()" class="btn" style="background: #6c757d;">Cancel</button>
            </div>
        </form>
    </div>
</div>

<script>
function openModal() {
    document.getElementById("customerModal").style.display = "block";
}

function closeModal() {
    document.getElementById("customerModal").style.display = "none";
}

function showQuickEdit(participantId) {
    document.getElementById("edit-form-" + participantId).style.display = "block";
}

function hideQuickEdit(participantId) {
    document.getElementById("edit-form-" + participantId).style.display = "none";
}

// Customer search functionality
const customerSearch = document.getElementById('customer-search');
const customerSelect = document.getElementById('{{ form.customer.id_for_label }}');
const suggestionsDiv = document.getElementById('customer-suggestions');

customerSearch.addEventListener('input', function() {
    const query = this.value.toLowerCase();
    if (query.length < 2) {
        suggestionsDiv.style.display = 'none';
        return;
    }
    
    // Filter customers based on search
    const options = Array.from(customerSelect.options);
    const matches = options.filter(option => 
        option.text.toLowerCase().includes(query) && option.value !== ''
    );
    
    if (matches.length > 0) {
        suggestionsDiv.innerHTML = matches.map(option => 
            `<div class="suggestion-item" data-value="${option.value}">${option.text}</div>`
        ).join('');
        suggestionsDiv.style.display = 'block';
    } else {
        suggestionsDiv.style.display = 'none';
    }
});

// Handle suggestion clicks
suggestionsDiv.addEventListener('click', function(e) {
    if (e.target.classList.contains('suggestion-item')) {
        const value = e.target.getAttribute('data-value');
        const text = e.target.textContent;
        
        customerSelect.value = value;
        customerSearch.value = text;
        suggestionsDiv.style.display = 'none';
    }
});

// Hide suggestions when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.form-group')) {
        suggestionsDiv.style.display = 'none';
    }
});

// Close modal when clicking outside of it
window.onclick = function(event) {
    var modal = document.getElementById("customerModal");
    if (event.target == modal) {
        modal.style.display = "none";
    }
}
</script>

{% endblock %}
