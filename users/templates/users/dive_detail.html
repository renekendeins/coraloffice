{% extends 'users/base.html' %}

{% block users_title %}Dive Details - {{ dive.dive_site.name }}{% endblock %}

{% block users_content %}
<style>
body {
    font-family: Arial, sans-serif;
    line-height: 1.4;
}

.header {
    text-align: center;
    margin-bottom: 30px;
    border-bottom: 2px solid #333;
    padding-bottom: 15px;
}

.dive-info {
    background: #f5f5f5;
    padding: 15px;
    margin-bottom: 20px;
    border-left: 4px solid #007bff;
}

.participants-table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 30px;
}

.participants-table th,
.participants-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
    font-size: 14px;
}

.participants-table th {
    background-color: #f8f9fa;
    font-weight: bold;
}

.equipment-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.equipment-card {
    border: 1px solid #ddd;
    padding: 15px;
    background: #f9f9f9;
}

.equipment-card h4 {
    margin-top: 0;
    color: #333;
    border-bottom: 1px solid #ddd;
    padding-bottom: 8px;
}

.equipment-item {
    display: flex;
    justify-content: space-between;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.equipment-item:last-child {
    border-bottom: none;
}

.btn {
    display: inline-block;
    padding: 8px 16px;
    background: #007bff;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    margin-right: 10px;
    border: none;
    cursor: pointer;
}

.btn-secondary { background: #6c757d; }
.btn-success { background: #28a745; }
.btn-primary { background: #007bff; }

.badge {
    display: inline-block;
    padding: 0.25em 0.4em;
    font-size: 0.75em;
    font-weight: 700;
    line-height: 1;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    border-radius: 0.25rem;
    color: white;
}

.bg-primary { background-color: #007bff; }
.bg-success { background-color: #28a745; }
.bg-warning { background-color: #ffc107; color: #212529; }
.bg-danger { background-color: #dc3545; }
.bg-dark { background-color: #343a40; }
.bg-secondary { background-color: #6c757d; }
.bg-info { background-color: #17a2b8; }
</style>

<div class="container mt-4">
    <!-- Header Section -->
    <div class="header">
        <h1>{{ dive.dive_site.name }}</h1>
        <h2>{{ dive.date|date:"F d, Y" }} at {{ dive.time|time:"g:i A" }}</h2>
        <p><strong>Participants:</strong> {{ participants.count }}/{{ dive.max_participants }}</p>
    </div>

    <!-- Dive Information -->
    <div class="dive-info">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div><strong>Location:</strong> {{ dive.dive_site.location }}</div>
            <div><strong>Depth Range:</strong> {{ dive.dive_site.depth_min }}m - {{ dive.dive_site.depth_max }}m</div>
            <div><strong>Difficulty:</strong> {{ dive.dive_site.get_difficulty_level_display }}</div>
            <div><strong>Max Participants:</strong> {{ dive.max_participants }}</div>
            <div><strong>Total Registered:</strong> {{ participants.count }}</div>
        </div>

        {% if dive.description %}
        <div style="margin-top: 15px;">
            <strong>Description:</strong> {{ dive.description }}
        </div>
        {% endif %}

        {% if dive.special_notes %}
        <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px;">
            <strong>‚ö†Ô∏è Special Notes:</strong> {{ dive.special_notes }}
        </div>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <div style="margin-bottom: 30px;">
        <a href="{% url 'users:manage_dive_participants' dive.id %}" class="btn btn-primary">
            <i class="fas fa-users me-1"></i>Manage Participants
        </a>
        <a href="{% url 'users:edit_dive' dive.id %}" class="btn btn-secondary">
            <i class="fas fa-edit me-1"></i>Edit Dive
        </a>
        <a href="{% url 'users:print_participants' dive.id %}" class="btn btn-success" target="_blank">
            <i class="fas fa-print me-1"></i>Print Participants
        </a>
    </div>

    <!-- Participants Table -->
    {% if participants %}
    <h3>Participants List</h3>
    <table class="participants-table">
        <thead>
            <tr>
                <th>Name</th>
                <th>Activity</th>
                <th>Tank Size</th>
                <th>Equipment Needed</th>
                <th>Status</th>
                <th>Assigned Staff</th>
                <th>Group</th>
                <th>Certification</th>
            </tr>
        </thead>
        <tbody>
            {% for participant in participants %}
            <tr>
                <td>
                    <strong>{{ participant.customer.first_name }} {{ participant.customer.last_name }}</strong><br>
                    <small>{{ participant.customer.country|default:"" }}</small>
                </td>
                <td>
                    {{ participant.course.name }}
                    {% if participant.course.just_one_dive %}
                        <span class="badge bg-info">Just One Dive</span>
                    {% endif %}
                    <div style="margin-top: 5px;">
                        {% if participant.course.includes_material %}
                            <span class="badge bg-success" style="margin-right: 3px; font-size: 10px;">Material</span>
                        {% endif %}
                        {% if participant.course.includes_instructor %}
                            <span class="badge bg-success" style="margin-right: 3px; font-size: 10px;">Instructor</span>
                        {% endif %}
                        {% if participant.course.includes_insurance %}
                            <span class="badge bg-success" style="margin-right: 3px; font-size: 10px;">Insurance</span>
                        {% endif %}
                    </div>
                </td>
                <td>{{ participant.get_tank_size_display }}</td>
                <td>
                    {% if participant.needs_wetsuit %}<span class="badge bg-secondary">Wetsuit ({{ participant.customer.get_wetsuit_size }})</span> {% endif %}
                    {% if participant.needs_bcd %}<span class="badge bg-secondary">BCD ({{ participant.customer.get_bcd_size }})</span> {% endif %}
                    {% if participant.needs_regulator %}<span class="badge bg-secondary">Regulator + Fins ({{ participant.customer.get_fins_size }})</span> {% endif %}
                    {% if participant.needs_guide %}<span class="badge bg-info">Guide</span> {% endif %}
                    {% if participant.needs_insurance %}<span class="badge bg-warning">Insurance</span> {% endif %}
                    {% if not participant.needs_wetsuit and not participant.needs_bcd and not participant.needs_regulator and not participant.needs_guide and not participant.needs_insurance %}-{% endif %}
                </td>
                <td>
                    <span class="badge {% if participant.status == 'PAID' %}bg-success{% elif participant.status == 'PENDING' %}bg-warning{% else %}bg-danger{% endif %}">
                        {{ participant.get_status_display }}
                    </span>
                </td>
                <td>
                    {% if participant.assigned_staff %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            {% if participant.assigned_staff.profile_picture %}
                                <img src="{{ participant.assigned_staff.profile_picture.url }}" alt="{{ participant.assigned_staff.get_full_name }}" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover;">
                            {% else %}
                                <div style="width: 24px; height: 24px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 12px;">üë®‚Äçüè´</div>
                            {% endif %}
                            <div>
                                <strong style="font-size: 12px;">{{ participant.assigned_staff.get_full_name }}</strong><br>
                                <small style="color: #666; font-size: 10px;">{{ participant.assigned_staff.get_certification_level_display }}</small>
                            </div>
                        </div>
                    {% else %}
                        <span style="color: #999; font-style: italic; font-size: 12px;">Not assigned</span>
                    {% endif %}
                </td>
                <td>
                    {% for membership in participant.customer.group_memberships.all %}
                        {% if membership.group.diving_center == dive.diving_center %}
                            <span class="badge" style="background-color: #9c27b0;">{{ membership.group.name }}</span>
                        {% endif %}
                    {% endfor %}
                </td>
                <td>{{ participant.customer.get_certification_level_display|default:"-" }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}

    <!-- Equipment Summary -->
    <div class="equipment-summary">
        <!-- Tank Summary -->
        <div class="equipment-card">
            <h4>üõ¢Ô∏è Tanks Required</h4>
            {% if tank_counts %}
                {% for tank in tank_counts %}
                <div class="equipment-item">
                    <span>{{ tank.tank_size }} Tank</span>
                    <span><strong>{{ tank.count }}</strong></span>
                </div>
                {% endfor %}
                <div class="equipment-item" style="border-top: 2px solid #333; margin-top: 10px; padding-top: 10px; font-weight: bold;">
                    <span>Total Tanks</span>
                    <span>{{ participants.count }}</span>
                </div>
            {% else %}
                <p>No tanks required yet</p>
            {% endif %}
        </div>

        <!-- Equipment Summary -->
        <div class="equipment-card">
            <h4>üéΩ Equipment Needed</h4>
            <div class="equipment-item">
                <span>Wetsuits</span>
                <span><strong>{{ equipment_counts.wetsuits }}</strong></span>
            </div>
            <div class="equipment-item">
                <span>BCDs</span>
                <span><strong>{{ equipment_counts.bcds }}</strong></span>
            </div>
            <div class="equipment-item">
                <span>Regulators</span>
                <span><strong>{{ equipment_counts.regulators }}</strong></span>
            </div>
            <div class="equipment-item">
                <span>Guides</span>
                <span><strong>{{ equipment_counts.guides }}</strong></span>
            </div>
            <div class="equipment-item">
                <span>Insurance</span>
                <span><strong>{{ equipment_counts.insurance }}</strong></span>
            </div>
        </div>

        <!-- Courses Summary -->
        <div class="equipment-card">
            <h4>üìä Courses Summary</h4>
            {% if participants %}
                {% regroup participants by course.name as course_groups %}
                {% for course_group in course_groups %}
                <div class="equipment-item">
                    <span>{{ course_group.grouper }}</span>
                    <span><strong>{{ course_group.list|length }}</strong></span>
                </div>
                {% endfor %}
            {% else %}
                <p>No courses scheduled</p>
            {% endif %}
        </div>

        <!-- Staff Summary -->
        <div class="equipment-card">
            <h4>üë®‚Äçüè´ Staff Assignments</h4>
            {% if participants %}
                {% regroup participants by assigned_staff as staff_groups %}
                {% for staff_group in staff_groups %}
                <div class="equipment-item">
                    <span>
                        {% if staff_group.grouper %}
                            {{ staff_group.grouper.get_full_name }}
                        {% else %}
                            <em>Unassigned</em>
                        {% endif %}
                    </span>
                    <span><strong>{{ staff_group.list|length }}</strong></span>
                </div>
                {% endfor %}
            {% else %}
                <p>No staff assignments</p>
            {% endif %}
        </div>

        <!-- Size Requirements -->
        {% if participants %}
        <div class="equipment-card">
            <h4>üìè Size Requirements</h4>
            {% for participant in participants %}
                {% if participant.needs_wetsuit or participant.needs_bcd or participant.needs_regulator %}
                <div style="padding: 8px 0; border-bottom: 1px solid #eee;">
                    <strong>{{ participant.customer.first_name }} {{ participant.customer.last_name }}</strong><br>
                    <small style="color: #666;">
                        {% if participant.needs_wetsuit %}
                            <span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">
                                Wetsuit: {{ participant.customer.get_wetsuit_size }}
                            </span>
                        {% endif %}
                        {% if participant.needs_bcd %}
                            <span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">
                                BCD: {{ participant.customer.get_bcd_size }}
                            </span>
                        {% endif %}
                        {% if participant.needs_regulator %}
                            <span style="background: #e9ecef; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">
                                Fins: {{ participant.customer.get_fins_size }}
                            </span>
                        {% endif %}
                    </small>
                </div>
                {% endif %}
            {% endfor %}
            {% if not participants|length %}
                <p>No equipment size requirements</p>
            {% endif %}
        </div>

        <!-- Equipment Summary by Size -->
        <div class="equipment-card">
            <h4>üì¶ Equipment by Size</h4>
            {% regroup participants by needs_wetsuit as wetsuit_groups %}
            {% if participants|length %}
                <!-- Wetsuit sizes -->
                {% for participant in participants %}
                    {% if participant.needs_wetsuit %}
                        {% if forloop.first %}<strong>Wetsuits needed:</strong><br>{% endif %}
                    {% endif %}
                {% endfor %}
                {% for participant in participants %}
                    {% if participant.needs_wetsuit %}
                        <span style="font-size: 12px; margin-right: 10px;">{{ participant.customer.get_wetsuit_size }}</span>
                    {% endif %}
                {% endfor %}
                
                <!-- BCD sizes -->
                {% for participant in participants %}
                    {% if participant.needs_bcd %}
                        {% if forloop.first %}<br><strong>BCDs needed:</strong><br>{% endif %}
                    {% endif %}
                {% endfor %}
                {% for participant in participants %}
                    {% if participant.needs_bcd %}
                        <span style="font-size: 12px; margin-right: 10px;">{{ participant.customer.get_bcd_size }}</span>
                    {% endif %}
                {% endfor %}
                
                <!-- Fins sizes -->
                {% for participant in participants %}
                    {% if participant.needs_regulator %}
                        {% if forloop.first %}<br><strong>Fins needed:</strong><br>{% endif %}
                    {% endif %}
                {% endfor %}
                {% for participant in participants %}
                    {% if participant.needs_regulator %}
                        <span style="font-size: 12px; margin-right: 10px;">{{ participant.customer.get_fins_size }}</span>
                    {% endif %}
                {% endfor %}
            {% else %}
                <p>No equipment sizes to display</p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if not participants %}
    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 8px; margin: 20px 0;">
        <h3>No participants yet</h3>
        <p>This dive doesn't have any participants registered.</p>
        <a href="{% url 'users:manage_dive_participants' dive.id %}" class="btn btn-primary">Add Participants</a>
    </div>
    {% endif %}
</div>
{% endblock %}